<?php
namespace App\Tests\WebScraper;

use App\WebScraper\Scraper;
use PHPUnit\Framework\TestCase;

class ScraperTest extends TestCase
{
    const JSON_TEST = '{"results":{"title":"House Prices in EC2","metaTagDescription":"The average price for a property in EC2 is &pound;1,283,054 over the last year. Use Rightmove online house price checker tool to find out exactly how much properties sold for in EC2 since 1995 (based on official Land Registry data).","containsScotland":false,"resultCount":"2,905","properties":[{"address":"Apartment 3502, The Heron, 5, Moor Lane, London, Greater London EC2Y 9BB","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;7,600,000","dateSold":"13 Dec 2018","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Flat 4801, 2, Principal Place, London, Greater London EC2A 2FG","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;6,398,060","dateSold":"16 Mar 2020","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.52305,"lng":-0.08332},"detailUrl":""},{"address":"Flat 4401, 2, Principal Place, London, Greater London EC2A 2FG","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;5,500,000","dateSold":"20 Dec 2019","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.52305,"lng":-0.08332},"detailUrl":""},{"address":"Flat 4601, 2, Principal Place, London, Greater London EC2A 2FG","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;5,495,370","dateSold":"25 Feb 2020","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.52305,"lng":-0.08332},"detailUrl":""},{"address":"Apartment 3303, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;5,050,000","dateSold":"11 Dec 2013","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Flat 3403, 5, Moor Lane, London, Greater London EC2Y 9BB","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;4,450,000","dateSold":"2 Apr 2015","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 3104, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;4,300,000","dateSold":"26 Mar 2014","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Flat 127, Bezier Apartments, 91, City Road, London, Greater London EC1Y 1AH","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;4,085,706","dateSold":"23 Mar 2016","tenure":"Leasehold","newBuild":false}],"location":{"lat":51.52491,"lng":-0.08713},"detailUrl":""},{"address":"Flat 3401, 5, Moor Lane, London, Greater London EC2Y 9BB","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,975,000","dateSold":"29 May 2015","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 3201, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,950,000","dateSold":"29 Aug 2013","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 3101, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,850,000","dateSold":"18 Sep 2014","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 3203, The Heron, 5, Moor Lane, London, Greater London EC2Y 9BB","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,800,000","dateSold":"18 Jan 2019","tenure":"Leasehold","newBuild":false}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 3402, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,750,000","dateSold":"3 Mar 2014","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 89, Roman House, Wood Street, London, Greater London EC2Y 5AG","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,650,000","dateSold":"30 Sep 2015","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51835,"lng":-0.09303},"detailUrl":""},{"address":"Apartment 3203, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,607,500","dateSold":"25 Nov 2013","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 3103, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,550,000","dateSold":"16 Sep 2013","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Flat 122, Bezier Apartments, 91, City Road, London, Greater London EC1Y 1AH","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,500,000","dateSold":"14 Aug 2013","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.52491,"lng":-0.08713},"detailUrl":""},{"address":"Apartment 3102, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,450,000","dateSold":"30 Jun 2014","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Flat 392, Lauderdale Tower, Barbican, London, Greater London EC2Y 8NA","propertyType":"Flat","bedrooms":3,"images":{"imageUrl":"https:\/\/media.rightmove.co.uk\/dir\/72k\/71134\/61427659\/71134_BAR100124_IMG_49_0000_max_135x100.jpg","count":48},"hasFloorPlan":true,"transactions":[{"displayPrice":"&pound;3,350,000","dateSold":"30 Nov 2017","tenure":"Leasehold","newBuild":false},{"displayPrice":"&pound;1,775,000","dateSold":"14 Aug 2007","tenure":"Leasehold","newBuild":false},{"displayPrice":"&pound;200,000","dateSold":"23 Dec 1998","tenure":"Leasehold","newBuild":false}],"location":{"lat":51.51985,"lng":-0.09686},"detailUrl":"https:\/\/www.rightmove.co.uk\/house-prices\/detailMatching.html?prop=61427659&sale=5892700&country=england"},{"address":"Apartment 88, Roman House, Wood Street, London, Greater London EC2Y 5BA","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,272,500","dateSold":"31 Oct 2014","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51764,"lng":-0.09349},"detailUrl":""},{"address":"Apartment 2906, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,210,000","dateSold":"10 Dec 2013","tenure":"Leasehold","newBuild":false}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 2706, The Heron, 5, Moor Lane, London, Greater London EC2Y 9AP","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,075,000","dateSold":"22 Oct 2013","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Flat 3302, 5, Moor Lane, London, Greater London EC2Y 9BB","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,050,000","dateSold":"11 Dec 2015","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51983,"lng":-0.09023},"detailUrl":""},{"address":"Apartment 15, Shield House, 16, New Street, London, Greater London EC2M 4TR","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,000,000","dateSold":"9 Apr 2013","tenure":"Leasehold","newBuild":false}],"location":{"lat":51.51715,"lng":-0.07996},"detailUrl":""},{"address":"Apartment 90, Roman House, Wood Street, London, Greater London EC2Y 5AG","propertyType":"Flat","bedrooms":null,"images":{"imageUrl":"\/spw\/images\/placeholder\/no-image.svg","count":0},"hasFloorPlan":false,"transactions":[{"displayPrice":"&pound;3,000,000","dateSold":"26 Feb 2015","tenure":"Leasehold","newBuild":true}],"location":{"lat":51.51835,"lng":-0.09303},"detailUrl":""}]},"sidebar":{"blurb":["Properties in EC2 had an overall average price of &pound;1,283,054 over the last year.","The majority of sales in EC2 during the last year were flats, selling for an average price of &pound;1,287,067. Terraced properties sold for an average of &pound;937,960.","Overall, sold prices in EC2 over the last year were 15% up on the previous year and 30% up on the 2017 peak of &pound;988,941."],"nearbyLocations":{"title":"House prices near EC2","links":[{"text":"House prices in Shoreditch","url":"\/house-prices\/shoreditch.html"},{"text":"House prices in Hackney","url":"\/house-prices\/hackney.html"},{"text":"House prices in Islington","url":"\/house-prices\/islington.html"},{"text":"House prices in Bermondsey","url":"\/house-prices\/bermondsey.html"},{"text":"House prices in Bethnal Green","url":"\/house-prices\/bethnal-green.html"},{"text":"House prices in Whitechapel","url":"\/house-prices\/whitechapel.html"},{"text":"House prices in Clerkenwell","url":"\/house-prices\/clerkenwell.html"},{"text":"House prices in Camden","url":"\/house-prices\/camden.html"},{"text":"House prices in Pimlico","url":"\/house-prices\/pimlico.html"},{"text":"House prices in Canary Wharf","url":"\/house-prices\/canary-wharf.html"}]},"propertyValueLinks":{"title":"What is your property worth?","links":[{"text":"Agent Property Valuation","url":"\/property-valuation.html"},{"text":"Market Trends","url":"\/house-prices-in-my-area.html"},{"text":"Price Comparison Report","url":"\/house-value.html"},{"text":"Estate agents in EC2","url":"\/estate-agents\/find.html?locationIdentifier=REGION^91984"},{"text":"Properties for sale in EC2","url":"\/property-for-sale\/find.html?locationIdentifier=REGION^91984"},{"text":"Properties to let in EC2","url":"\/property-to-rent\/find.html?locationIdentifier=REGION^91984"},{"text":"Selling guide","url":"\/resources\/property-guides\/selling-guide.html"},{"text":"Buying guide","url":"\/resources\/property-guides\/buying-guide.html"},{"text":"House Price Index","url":"\/news\/house-price-index"}]},"staticMapUrl":"https:\/\/media.rightmove.co.uk\/map\/_generate?polygonLineColor=%232E8E89FF&polygonFillColor=%232E8E8914&width=278&height=246&longitude=-0.08661818520100442&latitude=51.51933531083577&mapPolygon=umlyHn%60RjBuI%7EDoj%40e%40o%5DkOkNc%40_GnBoFkHwIuFpKsOwCaJgEuI%7BAyOtEb%40hK%60CbWfDtSnFp%40zMaAvE%60BsBp_%40I%60GhCtSzQwAfRtA&signature=L72msGY_SCwPnkwoQJmNBg6zecw=","mapViewUrl":"https:\/\/www.rightmove.co.uk\/house-prices\/search.html?showMapView=showMapView&housePricesMap=Map+View&locationIdentifier=REGION%5E91984&propertyType=0"},"searchLocation":{"displayName":"EC2","searchName":"ec2","locationType":"REGION","locationId":"91984"},"searchParameters":{},"searchParameterDefaults":{"radius":"0.0","soldIn":"30","propertyType":"ANY","propertyCategory":"ANY","tenure":"ANY","sortBy":"DATE_SOLD"},"pagination":{"current":1,"first":1,"last":40,"total":2905,"sortBy":"PRICE"},"leadValuationModel":null,"disclaimer":{"showLandReg":true,"showRos":false,"loadDates":{"landReg":{"earliestTransaction":"1 January 1995","mostRecentTransaction":"21 December 2020","lastLoadDate":"10 February 2021"},"ros":{"earliestTransaction":"18 October 1996","mostRecentTransaction":"31 December 2020","lastLoadDate":"10 February 2021"}}},"mortgageWidgetModel":{"currentAverage":"&pound;1,283,054","percentageChange":"15%","isIncrease":true}}';

    /**
     *
     */
    public function testNewPageUrl()
    {
        $scraper = new Scraper();
        $url = 'https://www.rightmove.co.uk/house-prices/ec2.html?page=39';
        $result = $scraper->newPageUrl($url, 'page', 40);

        // assert that your calculator added the numbers correctly!
        $equals = 'https://www.rightmove.co.uk/house-prices/ec2.html?page=40';
        $this->assertEquals($equals, $result);
    }

    /**
     *
     */
    public function testSubmitSearch()
    {
        $scraper = new Scraper();
        $url = 'https://www.rightmove.co.uk/house-prices.html';
        $searches = [
            'EC2' => 'https://www.rightmove.co.uk/house-prices/ec2.html?country=england&referrer=landingPage&searchLocation=EC2',
            'WC2' => 'https://www.rightmove.co.uk/house-prices/wc2.html?country=england&referrer=landingPage&searchLocation=WC2',
        ];
        
        foreach ($searches as $key => $value) {
            $forms = [];
            $form = new \stdClass();
            $form->selectButton = 'housePrices';
            $form->form = [
                'searchLocation' => $key
            ];
            $forms[] = $form;

            $result = $scraper->submitSearch($url, $forms);
            $this->assertEquals($value, $result);
        }
    }

    /**
     *
     */
    public function testGetSearchPageJsonData()
    {
        $scraper = new Scraper();

        $searches = [];
        $search = new \stdClass();
        $search->url = 'https://www.rightmove.co.uk/house-prices/ec2.html?country=england&referrer=landingPage&searchLocation=EC2&sortBy=PRICE_DESC';
        $search->start = "{\"results";
        $search->end = "window.__APP_CONFIG__";

        $searches[] = $search;

        foreach ($searches as $key => $value) {
            $current = $searches[$key];
            $result = $scraper->getSearchPageJsonData($current->url, $current->start, $current->end);

            $this->assertEquals(self::JSON_TEST, json_encode($result));
        }
    }
}